// TODO: Set path for iOS image resources, for 'build-images' task

var gulp          = require('gulp-param')(require('gulp'), process.argv);
var gutil         = require('gulp-util');
var bower         = require('bower');
var concat        = require('gulp-concat');
var uglify        = require('gulp-uglify');
var sass          = require('gulp-sass');
var minifyCss     = require('gulp-minify-css');
var rename        = require('gulp-rename');
var sh            = require('shelljs');
var preprocess    = require('gulp-preprocess');
var gulpif        = require('gulp-if');
var browserify    = require('browserify');
var source        = require('vinyl-source-stream');
var templateCache = require('gulp-angular-templatecache');
var del           = require('del');
var imagemin      = require('gulp-imagemin');
var shell         = require('gulp-shell');

var paths = {
  sass:       ['./scss/app.scss'],
  html:       ['./www/build/index.html'],
  templates:  ['./www/js/**/*.html', './www/templates/**/*.html'],
  vendor:     ['./www/lib/ionic/js/ionic.bundle.js'],
  js:         ['./www/js/app.js']
};

/* **********************************************************************************
 * Builds scss into css
 * **********************************************************************************/
gulp.task('build-css', function(dist) {
  gulp.src(paths.sass)
    .pipe(sass({errLogToConsole: true}))
    .pipe(gulpif(dist !== null, minifyCss({keepSpecialComments: 0})))
    .pipe(gulpif(dist !== null, rename({extname: '.min.css'})))
    .pipe(gulp.dest('./www/css/'));
});

/* **********************************************************************************
 * Builds all javascript files into one bundle
 * **********************************************************************************/
gulp.task('build-js', function(dist) {
  return browserify(paths.js)
    .bundle()
    .pipe(source('app.bundle.js'))
    .pipe(gulp.dest('./www/js/bundles/'));
});

/* **********************************************************************************
 * Uglify already bundled file
 * **********************************************************************************/
gulp.task('uglify', function(dist) {
  if (dist !== null) {
    return gulp.src('./www/js/bundles/app.bundle.js')
      .pipe(uglify())
      .pipe(rename({suffix: '.min'}))
      .pipe(gulp.dest('./www/js/bundles/'));
  }
});

/* **********************************************************************************
 * Builds html for development/production
 * **********************************************************************************/
gulp.task('build-html', function(dist) {
  gulp.src(paths.html)
    .pipe(preprocess({context: {ENVIRONMENT: dist !== null ? 'production' : 'development'}}))
    .pipe(gulp.dest('./www/'));
});

/* **********************************************************************************
 * Cache all angular templates to reduce the number of http requests
 * **********************************************************************************/
gulp.task('build-templatecache', function (done) {
  gulp.src(paths.templates)
    .pipe(templateCache())
    .pipe(gulp.dest('./www/js/utility/'));
});

/* **********************************************************************************
 * Optimize images in 'platforms' folder
 * **********************************************************************************/
gulp.task('build-images', function() {
  return gulp.src([
    './platforms/android/assets/www/img/*',
    './platforms/ios/www/img/*',
    './platforms/android/res/**/*.png',
    // './platforms/ios/APP_NAME/Resources/*'
    ],
    { base: './' })
    .pipe(imagemin({
      progressive: true,
      optimizationLevel: 5
    }))
    .pipe(gulp.dest('./'))
    .on('end', function() {
      console.log('compressed images.');
    });
});

/* **********************************************************************************
 * Builds vendor scripts. Same for development and production
 * **********************************************************************************/
gulp.task('build-vendor', function() {
  return gulp.src(paths.vendor)
    .pipe(concat('vendor.js'))
    .pipe(rename({suffix: '.min'}))
    .pipe(gulp.dest('./www/js/bundles/'));
});

/* **********************************************************************************
 * Delete unnecessary files from the application
 * **********************************************************************************/
gulp.task('delete-files', function() {
  //remove unneccesary files
  console.log('deleting files that are not needed...');
  del([
    'platforms/android/assets/www/lib/**',
    'platforms/android/assets/www/js/**/*.js',
    'platforms/android/assets/www/js/**/*.html',
    '!platforms/android/assets/www/js/bundles/app.bundle.min.js',
    '!platforms/android/assets/www/js/bundles/vendor.min.js',
    'platforms/android/assets/www/build/**',
    'platforms/android/assets/www/templates/**',
    'platforms/android/assets/www/css/app.css',
    'platforms/android/assets/_where-is-www.txt',

    './platforms/ios/www/lib/ionic/js/ionic-angular.js',
    './platforms/ios/www/lib/ionic/js/ionic.bundle.js',
    './platforms/ios/www/lib/ionic/js/ionic.js',
    './platforms/ios/www/lib/ionic/js/angular/angular-animate.js',
    './platforms/ios/www/lib/ionic/js/angular/angular-resource.js',
    './platforms/ios/www/lib/ionic/js/angular/ionic-sanitize.js',
    './platforms/ios/www/lib/ionic/js/angular/angular.js',
    './platforms/ios/www/lib/ionic/js/angular-ui/angular-ui-router.js',
    './platforms/ios/www/lib/ionic/scss',
    './platforms/ios/www/lib/ionic/version.json',
    ], function() {
      console.log('removed unnecessary files');
    })
});


/* **********************************************************************************
 * Indicate user whether 'DEBUG' or 'RELEASE' build is used
 * **********************************************************************************/
gulp.task('release-detect', function() {
  process.env.target = 'DEBUG';

  if (process.env.CORDOVA_CMDLINE && process.env.CORDOVA_CMDLINE.indexOf('--release') > 0) {
    process.env.target = 'RELEASE';
    console.log('\x1b[41m%s\x1b[0m','\n\t\tRELEASE build is being prepared!!!!\n\t\tThis app will use live data!!!\n');
  }

  //we will prepare only available platforms
  process.env.targetAndroid = false;
  process.env.targetIos     = false;
  //process.env.CORDOVA_PLATFORMS = 'android,ios';
  
  if (process.env.CORDOVA_PLATFORMS) {
    var platforms = process.env.CORDOVA_PLATFORMS.toLowerCase();
    process.env.targetAndroid = platforms.split(',').indexOf('android') >= 0 ? true : false;
    process.env.targetIos = platforms.split(',').indexOf('ios') >= 0 ? true : false;
  }

  if (process.env.targetAndroid == 'true') { console.log('Android platform detected'); }
  if (process.env.targetIos == 'true') { console.log('IOS platform detected'); }
})

/* **********************************************************************************
 * This task is usually called from a hook to prepare files for building
 * **********************************************************************************/
gulp.task('build-prepare', ['release-detect', 'default', 'build-resources', 'build-images', 'delete-files', 'version-increase'], function() {
  console.log('build-prepare done');
});

/* **********************************************************************************
 * Preparation tasks. Installs all javascript lib dependencies defined in bower.json 
 * **********************************************************************************/
gulp.task('install', ['git-check'], function() {
  return bower.commands.install()
    .on('log', function(data) {
      gutil.log('bower', gutil.colors.cyan(data.id), data.message);
    });
});

gulp.task('git-check', function() {
  if (!sh.which('git')) {
    console.log(
      '  ' + gutil.colors.red('Git is not installed.'),
      '\n  Git, the version control system, is required to download Ionic.',
      '\n  Download git here:', gutil.colors.cyan('http://git-scm.com/downloads') + '.',
      '\n  Once git is installed, run \'' + gutil.colors.cyan('gulp install') + '\' again.'
    );
    process.exit(1);
  }
});

/* **********************************************************************************
 * Install plugins manually
 * **********************************************************************************/
gulp.task('reinstall-plugins', function() {
  console.log('reinstalling ionic plugins...');
  var pluginlist = [
    "com.ionic.keyboard"
  ];

  // no need to configure below
  var fs    = require('fs');
  var path  = require('path');
  var sys   = require('sys')
  var exec  = require('child_process').exec;

  function puts(error, stdout, stderr) {
    sys.puts(stdout)
  }

  pluginlist.forEach(function(plug) {
    exec("ionic plugin add " + plug, puts);
  });
});

/* **********************************************************************************
 * Increase version number only if '--release' flag is set
 * **********************************************************************************/
gulp.task('version-increase', function() {
  if (process.env.CORDOVA_CMDLINE && process.env.CORDOVA_CMDLINE.indexOf('--release') > 0) {
    var fs = require('fs');

    fs.readFile("config.xml", 'utf8', function (err,data) {
      if (err) {
        return console.log(err);
      }

      var version = data.match(/(<widget [^>]* version=\"[1-9]+\.[0-9]+\.)([0-9]+)(\")/i)[2];
      console.log('current minor version number is ',version, " increasing it to ", parseInt(version)+1);
      version++;

      var result = data.replace(/(<widget [^>]* version=\"[1-9]+\.[0-9]+\.)([0-9]+)(\")/i, '$1' + version + '$3');

      fs.writeFile("config.xml", result, 'utf8', function (err) {
         if (err) return console.log(err);
      });
    });
  }
});

/* **********************************************************************************
 * Generates icons and splash screen images for all platforms
 * **********************************************************************************/
gulp.task('build-resources', shell.task([
  'ionic resources'
]));

/* **********************************************************************************
 * Watch task. Development only.
 * **********************************************************************************/
gulp.task('watch', function() {
  gulp.watch(['./scss/**/*.scss', './www/js/**/*.js', paths.html], ['build-css', 'build-js', 'build-html']);
});

gulp.task('default', ['build-css', 'build-js', 'uglify', 'build-vendor', 'build-templatecache', 'build-html']);